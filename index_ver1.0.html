<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AWS Master v2.0 (JSON Edition)</title>
<style>
  :root { --primary: #232f3e; --secondary: #ff9900; --bg: #f8f9fa; --text: #222; --correct: #2e7d32; --wrong: #c62828; --bookmark: #fbc02d; --vocab: #00897b; --clf: #e91e63; --saa: #1565c0; --sap: #673ab7; }
  body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
  .app-container { max-width: 800px; margin: 0 auto; width: 100%; height: 100%; display: flex; flex-direction: column; background: white; position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
  .screen { display: none; flex: 1; flex-direction: column; padding: 16px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  .screen.active { display: flex; animation: fadeIn 0.2s ease-out; }
  
  /* Header */
  .app-header { background: var(--primary); color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; z-index: 10; flex-shrink: 0; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .logo { font-weight: 800; font-size: 18px; display: flex; align-items: center; gap: 6px; }
  .logo span { color: var(--secondary); }
  .header-controls { display: flex; gap: 8px; align-items: center; }
  .timer-display { font-family: monospace; font-size: 16px; font-weight: bold; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; display: none; color: #fff; }
  .lang-select { background: rgba(255,255,255,0.2); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; }
  .lang-select option { background: #333; }
  .btn-quit { font-size: 11px; color: var(--primary); background: #fff; padding: 6px 12px; border-radius: 15px; cursor: pointer; border: none; font-weight: bold; }

  /* Home */
  .home-title { font-size: 20px; margin: 10px 0 5px; text-align: center; color: var(--primary); font-weight: 700; }
  .home-subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 12px; }
  .resume-alert { background: #e3f2fd; border: 1px solid #90caf9; color: #0d47a1; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center; cursor: pointer; font-weight: bold; font-size: 14px; }

  /* Cards */
  .course-section-title { font-size: 13px; font-weight: 800; margin: 20px 0 10px; padding-left: 10px; border-left: 4px solid #ccc; color: #555; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: space-between; }
  .course-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .course-card { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 14px; text-align: center; cursor: pointer; transition: all 0.15s; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.03); display: flex; flex-direction: column; justify-content: center; min-height: 85px; }
  .course-card:active { transform: scale(0.98); background: #fafafa; }
  
  .mode-badge { font-size: 9px; font-weight: bold; padding: 2px 6px; border-radius: 4px; position: absolute; top: 8px; right: 8px; color: white; text-transform: uppercase; }
  .badge-quick { background: #4caf50; }
  .badge-hard { background: #ff9800; }
  .badge-endless { background: #9c27b0; }
  .badge-exam { background: #d32f2f; }

  .clf-card { border-top: 3px solid var(--clf); }
  .saa-card { border-top: 3px solid var(--saa); }
  .sap-card { border-top: 3px solid var(--sap); }
  .vocab-card { border-top: 3px solid var(--vocab); background: #f0fdfc; }
  .weak-card { background: #fff5f5; border-top: 3px solid var(--wrong); }
  .bk-card { background: #fffde7; border-top: 3px solid var(--bookmark); }

  .count-badge { position: absolute; top: -6px; right: -6px; color: white; font-size: 10px; font-weight: bold; padding: 3px 8px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
  .bg-weak { background: var(--wrong); }
  .bg-bk { background: var(--bookmark); color: #333; }

  .course-name { font-weight: 700; font-size: 13px; display: block; margin-top: 10px; color: #333; }
  .course-desc { font-size: 10px; color: #777; margin-top: 3px; display: block; }
  .course-icon { font-size: 24px; display: block; margin-bottom: 4px; }

  /* Quiz */
  .progress-area { margin-bottom: 15px; }
  .progress-bar-bg { width: 100%; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; }
  .progress-bar-fill { height: 100%; background: var(--secondary); width: 0%; transition: width 0.3s ease; }
  .status-text { font-size: 12px; color: #555; display: flex; justify-content: space-between; margin-top: 5px; font-weight: 600; }
  
  .question-container { position: relative; }
  .bookmark-btn { position: absolute; top: -10px; right: -10px; background: white; border: 1px solid #ddd; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; color: #ccc; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s; z-index: 5; }
  .bookmark-btn.active { color: var(--bookmark); border-color: var(--bookmark); }
  .bookmark-btn:active { transform: scale(0.9); }

  .question-box { font-size: 16px; line-height: 1.6; font-weight: 500; margin-bottom: 20px; padding: 20px; background: #fff; border-left: 4px solid var(--primary); border-radius: 8px; color: #222; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  .tag-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 10px; margin-bottom: 12px; font-weight: bold; text-transform: uppercase; color: white; }
  .tag-clf { background: var(--clf); }
  .tag-saa { background: var(--saa); }
  .tag-sap { background: var(--sap); }
  .tag-vocab { background: var(--vocab); }
  
  .option-btn { background: white; border: 1px solid #dcdcdc; border-radius: 8px; padding: 15px; margin-bottom: 10px; text-align: left; font-size: 14px; cursor: pointer; position: relative; line-height: 1.4; transition: background 0.1s; color: #444; }
  .option-btn:active { background: #f5f5f5; }
  .option-btn.correct { border: 2px solid var(--correct); background: #e8f5e9; color: var(--correct); font-weight: 700; border-color: var(--correct); }
  .option-btn.wrong { border: 2px solid var(--wrong); background: #ffebee; opacity: 0.8; border-color: var(--wrong); }

  .feedback-box { margin-top: 15px; padding: 15px; background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 8px; display: none; animation: slideUp 0.3s; margin-bottom: 80px; }
  .feedback-title { font-weight: 800; color: var(--correct); margin-bottom: 8px; display: block; font-size: 15px; }
  
  .footer-area { position: sticky; bottom: 0; background: linear-gradient(to top, rgba(255,255,255,1) 90%, rgba(255,255,255,0)); padding: 15px 0 25px; text-align: center; margin-top: auto; pointer-events: none; }
  .footer-area button { pointer-events: auto; }
  .btn-next { background: var(--secondary); color: #000; border: none; padding: 14px 40px; border-radius: 30px; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.15); min-width: 200px; transition: transform 0.1s; }
  .btn-next:active { transform: scale(0.96); }
  
  .score-display { text-align: center; padding: 30px 0; }
  .score-number { font-size: 48px; font-weight: 800; color: var(--primary); }
  .score-msg { font-size: 16px; font-weight: bold; margin-top: 5px; color: var(--secondary); }
  .review-list { margin-top: 20px; }
  .review-item { border-bottom: 1px solid #eee; padding: 12px 0; }
  .review-q { font-weight: bold; font-size: 12px; margin-bottom: 4px; display: block; color: #555; }
  .review-a { color: var(--correct); font-size: 13px; font-weight: bold; }

  .seo-guide { margin-top:40px; padding:20px; background:#fff; border-radius:8px; border:1px solid #eee; color:#666; font-size:12px; line-height:1.7; }
  .seo-guide h3 { color:var(--primary); font-size:14px; margin-top:10px; border-bottom:1px solid #eee; padding-bottom:4px; margin-bottom: 8px; }

  .hidden { display: none !important; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7804916394997850"
     crossorigin="anonymous"></script>
</head>
<body>

<div class="app-container">
  <header class="app-header">
    <div class="logo">AWS <span>Master</span></div>
    <div class="header-controls">
      <div id="quizTimer" class="timer-display">00:00</div>
      <select id="langSelect" class="lang-select" onchange="changeLanguage(this.value)">
        <option value="ja">ğŸ‡¯ğŸ‡µ</option>
        <option value="en">ğŸ‡ºğŸ‡¸</option>
        <option value="zh">ğŸ‡¨ğŸ‡³</option>
        <option value="es">ğŸ‡ªğŸ‡¸</option>
      </select>
      <button id="quitBtn" class="btn-quit hidden" onclick="goHome()">
        <span data-t="quit">âœ•</span>
      </button>
    </div>
  </header>

  <div id="homeScreen" class="screen">
    <div class="home-title" data-t="home_title">å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰é¸æŠ</div>
    <p class="home-subtitle" data-t="home_subtitle">åŸºç¤ã‹ã‚‰å®Ÿè·µã¾ã§å®Œå…¨ç¶²ç¾…</p>
    
    <div id="resumeArea" class="resume-alert hidden" onclick="resumeGame()">
      ğŸ”„ <span data-t="resume">å†é–‹</span>
    </div>

    <div class="course-section-title" data-t="sec_review">Review</div>
    <div class="course-grid">
      <div class="course-card weak-card" onclick="startCourse('weakness')">
        <span class="course-icon">ğŸ”¥</span>
        <span class="course-name" data-t="weak_mode">è‹¦æ‰‹å…‹æœ</span>
        <span id="weakCount" class="course-desc">...</span>
        <div id="weakBadge" class="count-badge bg-weak hidden">0</div>
      </div>
      <div class="course-card bk-card" onclick="startCourse('bookmark')">
        <span class="course-icon">â­</span>
        <span class="course-name" data-t="bk_mode">Bookmarks</span>
        <span id="bkCount" class="course-desc">...</span>
        <div id="bkBadge" class="count-badge bg-bk hidden">0</div>
      </div>
    </div>

    <div class="course-section-title section-vocab" data-t="sec_vocab">Vocabulary (å˜èªå¸³)</div>
    <div class="course-grid">
      <div class="course-card vocab-card" onclick="startCourse('vocab_clf')">
        <span class="mode-badge" style="background:var(--clf)">CLF</span>
        <span class="course-name">CLA Words</span>
        <span class="course-desc">Basic Terms</span>
      </div>
      <div class="course-card vocab-card" onclick="startCourse('vocab_saa')">
        <span class="mode-badge" style="background:var(--saa)">SAA</span>
        <span class="course-name">SAA Words</span>
        <span class="course-desc">Key Features</span>
      </div>
      <div class="course-card vocab-card" onclick="startCourse('vocab_sap')">
        <span class="mode-badge" style="background:var(--sap)">SAP</span>
        <span class="course-name">SAP Words</span>
        <span class="course-desc">Advanced</span>
      </div>
    </div>

    <div class="course-section-title section-clf">Cloud Practitioner (CLF)</div>
    <div class="course-grid">
      <div class="course-card clf-card" onclick="startCourse('clf_quick')">
        <span class="mode-badge badge-quick">Quick</span>
        <span class="course-name" data-t="mode_quick">ã‚¯ã‚¤ãƒƒã‚¯</span>
        <span class="course-desc">10 Qs</span>
      </div>
      <div class="course-card clf-card" onclick="startCourse('clf_hard')">
        <span class="mode-badge badge-hard">Hard</span>
        <span class="course-name" data-t="mode_hard">æ¼”ç¿’</span>
        <span class="course-desc">30 Qs</span>
      </div>
      <div class="course-card clf-card" onclick="startCourse('clf_endless')">
        <span class="mode-badge badge-endless">Endless</span>
        <span class="course-name" data-t="mode_endless">ç„¡é™</span>
        <span class="course-desc">âˆ</span>
      </div>
      <div class="course-card clf-card" onclick="startCourse('clf_exam')">
        <span class="mode-badge badge-exam">Exam</span>
        <span class="course-name" data-t="mode_exam">æœ¬ç•ªæ¨¡è©¦</span>
        <span class="course-desc">65 Qs / 90m</span>
      </div>
    </div>

    <div class="course-section-title section-saa">Solutions Architect (SAA)</div>
    <div class="course-grid">
      <div class="course-card saa-card" onclick="startCourse('saa_quick')">
        <span class="mode-badge badge-quick">Quick</span>
        <span class="course-name" data-t="mode_quick">ã‚¯ã‚¤ãƒƒã‚¯</span>
        <span class="course-desc">15 Qs</span>
      </div>
      <div class="course-card saa-card" onclick="startCourse('saa_hard')">
        <span class="mode-badge badge-hard">Hard</span>
        <span class="course-name" data-t="mode_hard">æ¼”ç¿’</span>
        <span class="course-desc">30 Qs</span>
      </div>
      <div class="course-card saa-card" onclick="startCourse('saa_endless')">
        <span class="mode-badge badge-endless">Endless</span>
        <span class="course-name" data-t="mode_endless">ç„¡é™</span>
        <span class="course-desc">125+ Qs</span>
      </div>
      <div class="course-card saa-card" onclick="startCourse('saa_exam')">
        <span class="mode-badge badge-exam">Exam</span>
        <span class="course-name" data-t="mode_exam">æœ¬ç•ªæ¨¡è©¦</span>
        <span class="course-desc">65 Qs / 130m</span>
      </div>
    </div>

    <div class="course-section-title section-sap">Professional (SAP)</div>
    <div class="course-grid">
      <div class="course-card sap-card" onclick="startCourse('sap_quick')">
        <span class="mode-badge badge-quick">Quick</span>
        <span class="course-name" data-t="mode_quick">ã‚¯ã‚¤ãƒƒã‚¯</span>
        <span class="course-desc">10 Qs</span>
      </div>
      <div class="course-card sap-card" onclick="startCourse('sap_hard')">
        <span class="mode-badge badge-hard">Hard</span>
        <span class="course-name" data-t="mode_hard">æ¼”ç¿’</span>
        <span class="course-desc">30 Qs</span>
      </div>
      <div class="course-card sap-card" onclick="startCourse('sap_endless')">
        <span class="mode-badge badge-endless">Endless</span>
        <span class="course-name" data-t="mode_endless">ç„¡é™</span>
        <span class="course-desc">âˆ</span>
      </div>
      <div class="course-card sap-card" onclick="startCourse('sap_exam')">
        <span class="mode-badge badge-exam">Exam</span>
        <span class="course-name" data-t="mode_exam">æœ¬ç•ªæ¨¡è©¦</span>
        <span class="course-desc">75 Qs / 180m</span>
      </div>
    </div>

    <div class="seo-guide">
      <h3 data-t="guide_title">AWSèªå®šè©¦é¨“ å­¦ç¿’ã‚¬ã‚¤ãƒ‰</h3>
      <p data-t="guide_text">CLF, SAA, SAPã®å…¨ãƒ¬ãƒ™ãƒ«ã«å¯¾å¿œã€‚æœ¬ç•ªå½¢å¼ã®æ¨¡è©¦ãƒ¢ãƒ¼ãƒ‰ã§å®ŸåŠ›ã‚’æ¸¬ã‚Šã¾ã—ã‚‡ã†ã€‚</p>
    </div>
  </div>

  <div id="quizScreen" class="screen">
    <div class="progress-area">
      <div class="progress-bar-bg"><div id="progressBar" class="progress-bar-fill"></div></div>
      <div class="status-text"><span id="qCount">Q.1</span><span id="scorePreview">Score: 0</span></div>
    </div>
    
    <div id="quizContent">
      <span id="levelBadge" class="tag-badge">SAA</span>
      <div class="question-container">
        <div id="qText" class="question-box"></div>
        <div id="btnBookmark" class="bookmark-btn" onclick="toggleBookmark()">â˜…</div>
      </div>
      <div id="optionsArea"></div>
    </div>

    <div id="feedbackArea" class="feedback-box">
      <span class="feedback-title"></span>
      <div id="explanationText" style="font-size:14px; line-height:1.7;">
        </div>
    </div>

    <div class="footer-area">
      <button id="nextBtn" class="btn-next hidden" onclick="nextQuestion()">Next</button>
      <button id="finishBtn" class="btn-next hidden" style="background:#ddd;" onclick="finishQuiz()">Finish</button>
    </div>
  </div>

  <div id="resultScreen" class="screen">
    <div class="score-display">
      <div style="font-size:13px; color:#666;" data-t="score_label">Score</div>
      <div id="finalScore" class="score-number">0%</div>
      <div id="resultMsg" class="score-msg"></div>
    </div>
    <div style="font-weight:bold; border-bottom:1px solid #ddd; padding-bottom:5px; margin-bottom:10px;" data-t="review_label">Review</div>
    <div id="reviewList" class="review-list"></div>
    <div class="footer-area"><button class="btn-next" onclick="goHome()" data-t="home_btn">Home</button></div>
  </div>
</div>

<script>
/* ==========================================
   0. Security & Anti-Debug (ç°¡æ˜“ãƒ—ãƒ­ãƒ†ã‚¯ãƒˆ)
   ========================================== */
(function() {
  document.addEventListener('contextmenu', event => event.preventDefault());
  document.onkeydown = function(e) {
    if (e.keyCode == 123) { return false; } // F12
    if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; }
    if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; }
    if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; }
    if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; }
  };
  setInterval(function() {
    const startTime = performance.now();
    debugger; 
    const endTime = performance.now();
    if (endTime - startTime > 100) {
      // é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«æ¤œçŸ¥æ™‚ã®å‡¦ç†ï¼ˆå¿…è¦ãªã‚‰æœ‰åŠ¹åŒ–ï¼‰
      // alert("DevTools detected.");
    }
  }, 1000);
})();

/* ==========================================
   1. Logic & Data Fetching
   ========================================== */
const SESSION_KEY = 'aws_v9_session';
const WEAK_KEY = 'aws_v9_weak';
const BK_KEY = 'aws_v9_bookmark';
let appState = { mode: '', questions: [], currentIndex: 0, correctCount: 0, wrongList: [] };
let currentLang = 'ja';
let timerInterval = null;

// ãƒ‡ãƒ¼ã‚¿æ ¼ç´ç”¨å¤‰æ•°
let vocabClfData = [], vocabSaaData = [], vocabSapData = [];
let clfData = [], saaData = [], sapData = [], allData = [];

// ç¿»è¨³ãƒ‡ãƒ¼ã‚¿
const TRANSLATIONS = {
  ja: {
    quit: "ä¸­æ–­", home_title: "å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰é¸æŠ", home_subtitle: "åŸºç¤ã‹ã‚‰å®Ÿè·µã¾ã§å®Œå…¨ç¶²ç¾…", resume: "å†é–‹",
    sec_review: "å¾©ç¿’ï¼†ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯", weak_mode: "è‹¦æ‰‹å…‹æœ", bk_mode: "ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯",
    sec_vocab: "ç”¨èªæš—è¨˜", vocab_mode: "å˜èªå¸³", vocab_desc: "åŸºæœ¬ç”¨èªãƒ‰ãƒªãƒ«",
    mode_quick: "ã‚¯ã‚¤ãƒƒã‚¯", mode_hard: "æ¼”ç¿’", mode_endless: "ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹", mode_exam: "æœ¬ç•ªæ¨¡è©¦",
    guide_title: "å­¦ç¿’ã‚¬ã‚¤ãƒ‰", guide_text: "CLF/SAA/SAPå¯¾å¿œã€‚â˜…ãƒœã‚¿ãƒ³ã§å•é¡Œã‚’ä¿å­˜ã§ãã¾ã™ã€‚",
    score_label: "æ­£è§£ç‡", review_label: "å¾©ç¿’", home_btn: "ãƒ›ãƒ¼ãƒ ", next_btn: "æ¬¡ã¸", finish_btn: "çµæœ",
    correct: "æ­£è§£", wrong: "ä¸æ­£è§£", point: "ãƒã‚¤ãƒ³ãƒˆ", solution: "è§£", ad_title: "åˆæ ¼ã¸ã®è¿‘é“", ad_btn: "å‚è€ƒæ›¸ã‚’æ¢ã™"
  },
  en: {
    quit: "Quit", home_title: "Select Mode", home_subtitle: "Full Exam Prep", resume: "Resume",
    sec_review: "Review", weak_mode: "Weakness", bk_mode: "Bookmarks",
    sec_vocab: "Vocabulary", vocab_mode: "Vocab Drill", vocab_desc: "Basics",
    mode_quick: "Quick", mode_hard: "Hard", mode_endless: "Endless", mode_exam: "Exam Sim",
    guide_title: "Guide", guide_text: "Supports CLF/SAA/SAP. Use â˜… to bookmark questions.",
    score_label: "Score", review_label: "Review", home_btn: "Home", next_btn: "Next", finish_btn: "Finish",
    correct: "Correct", wrong: "Wrong", point: "Point", solution: "Ans", ad_title: "Recommended", ad_btn: "Find Books"
  }
};

document.addEventListener('DOMContentLoaded', () => {
  const savedLang = localStorage.getItem('aws_app_lang');
  if(savedLang) { currentLang = savedLang; document.getElementById('langSelect').value = savedLang; }
  applyTranslation();
  
  window.history.replaceState({screen:'homeScreen'},'','#home');
  window.addEventListener('popstate', e => {
    if(e.state && e.state.screen) _show(e.state.screen); else _show('homeScreen');
  });

  // data.jsonã‚’èª­ã¿è¾¼ã‚€
  loadExternalData().then(() => {
     try { checkSession(); updateBadges(); _show('homeScreen'); } 
     catch(e) { console.error(e); localStorage.clear(); _show('homeScreen'); }
  });
});

// JSONèª­ã¿è¾¼ã¿é–¢æ•°
async function loadExternalData() {
   try {
     const response = await fetch('./data.json');
     if (!response.ok) throw new Error("JSON not found");
     const data = await response.json();
     
     // Vocabãƒ‡ãƒ¼ã‚¿ã®å±•é–‹ (ã‚¨ãƒ©ãƒ¼é˜²æ­¢ã®ãŸã‚ãƒ«ãƒ¼ãƒ—ã§å¢—ã‚„ã™)
     vocabClfData = expandArray(data.vocabClf, 30);
     vocabSaaData = expandArray(data.vocabSaa, 30);
     vocabSapData = expandArray(data.vocabSap, 30);
     
     // ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã®å±•é–‹
     const baseClf = expandArray(data.baseClf, 100);
     const baseSaa = expandArray(data.baseSaa, 100);
     const baseSap = expandArray(data.baseSap, 100);
     
     // ã‚¢ãƒ—ãƒªç”¨ã«IDä»˜ä¸
     clfData = expandData(baseClf, 125, 'clf');
     saaData = expandData(baseSaa, 125, 'saa');
     sapData = expandData(baseSap, 125, 'sap');
     
     // å…¨ãƒ‡ãƒ¼ã‚¿çµåˆï¼ˆæ¤œç´¢ç”¨ï¼‰
     allData = [...vocabClfData, ...vocabSaaData, ...vocabSapData, ...clfData, ...saaData, ...sapData];
     
   } catch(e) {
     console.error("Data Load Error:", e);
     alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ã„ã¦ã„ã‚‹å ´åˆã¯GitHubç­‰ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
   }
}

// ãƒ‡ãƒ¼ã‚¿ã®æ°´å¢—ã— (ãƒ«ãƒ¼ãƒ—ã•ã›ã‚‹)
function expandArray(arr, minLength) {
    if (!arr || arr.length === 0) return [];
    let result = [...arr];
    while (result.length < minLength) {
        result.push(...arr); 
    }
    return result; // å˜ç´”ã‚³ãƒ”ãƒ¼ã§ååˆ†
}

// IDä»˜ä¸ç”¨
function expandData(base, targetCount, prefix) {
  let result = [];
  let count = 0;
  if(!base || base.length === 0) return [];
  while (result.length < targetCount) {
    for (let item of base) {
      if (result.length >= targetCount) break;
      let newId = `${prefix}_${count}`;
      result.push({ ...item, id: newId });
      count++;
    }
  }
  return result;
}

/* ==========================================
   UI & Game Logic
   ========================================== */
function changeLanguage(val) { 
  currentLang = val; 
  localStorage.setItem('aws_app_lang', val); 
  applyTranslation(); 
  if(document.getElementById('quizScreen').classList.contains('active')) renderQuestion();
}

function applyTranslation() {
  const t = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
  document.querySelectorAll('[data-t]').forEach(el => {
    const k = el.getAttribute('data-t');
    if(t[k]) el.innerText = t[k];
  });
  updateBadges();
}

function getLocalizedText(obj) {
  if (typeof obj === 'string') return obj;
  return obj[currentLang] || obj['en'] || obj['ja'] || "";
}

function _show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const timer = document.getElementById('quizTimer');
  if(id === 'quizScreen') {
    document.getElementById('quitBtn').classList.remove('hidden');
    if(appState.mode && appState.mode.includes('exam')) {
      timer.style.display = 'block'; startTimer();
    } else {
      timer.style.display = 'none'; stopTimer();
    }
  } else {
    document.getElementById('quitBtn').classList.add('hidden');
    timer.style.display = 'none'; stopTimer();
  }
  if(id === 'homeScreen') { checkSession(); updateBadges(); }
}
function showScreen(id) { window.history.pushState({screen:id}, '', `#${id.replace('Screen','')}`); _show(id); }
function goHome() { if(window.history.length>1) window.history.back(); else { window.history.replaceState({screen:'homeScreen'},'','#home'); _show('homeScreen'); } }

function startTimer() { stopTimer(); const start = Date.now(); timerInterval = setInterval(() => {
  const d = Math.floor((Date.now()-start)/1000);
  const m = Math.floor(d/60).toString().padStart(2,'0');
  const s = (d%60).toString().padStart(2,'0');
  document.getElementById('quizTimer').innerText = `${m}:${s}`;
}, 1000); }
function stopTimer() { if(timerInterval) clearInterval(timerInterval); document.getElementById('quizTimer').innerText = "00:00"; }

function getList(key) { return JSON.parse(localStorage.getItem(key)||'[]'); }
function addToList(key, id) { const l = getList(key); if(!l.includes(id)) { l.push(id); localStorage.setItem(key, JSON.stringify(l)); } }
function removeFromList(key, id) { const l = getList(key).filter(i=>i!==id); localStorage.setItem(key, JSON.stringify(l)); }
function hasInList(key, id) { return getList(key).includes(id); }

function updateBadges() {
  const w = getList(WEAK_KEY).length;
  const b = getList(BK_KEY).length;
  document.getElementById('weakCount').innerText = (currentLang==='ja' ? `æ®‹ã‚Š${w}å•` : `${w} left`);
  const wb = document.getElementById('weakBadge');
  if(w>0) { wb.innerText = w; wb.classList.remove('hidden'); } else wb.classList.add('hidden');
  document.getElementById('bkCount').innerText = (currentLang==='ja' ? `${b}å•` : `${b} saved`);
  const bb = document.getElementById('bkBadge');
  if(b>0) { bb.innerText = b; bb.classList.remove('hidden'); } else bb.classList.add('hidden');
}

function toggleBookmark() {
  if(!appState.questions.length) return;
  const q = appState.questions[appState.currentIndex];
  const btn = document.getElementById('btnBookmark');
  if(hasInList(BK_KEY, q.id)) { removeFromList(BK_KEY, q.id); btn.classList.remove('active'); } 
  else { addToList(BK_KEY, q.id); btn.classList.add('active'); }
}

function startCourse(mode) {
  localStorage.removeItem(SESSION_KEY);
  appState = { mode: mode, questions: [], currentIndex: 0, correctCount: 0, wrongList: [] };
  
  let pool = [];
  if(mode.startsWith('clf')) pool = [...clfData];
  else if(mode.startsWith('saa')) pool = [...saaData];
  else if(mode.startsWith('sap')) pool = [...sapData];
  else if(mode === 'vocab_clf') pool = [...vocabClfData];
  else if(mode === 'vocab_saa') pool = [...vocabSaaData];
  else if(mode === 'vocab_sap') pool = [...vocabSapData];
  else if(mode === 'weakness') {
    const ids = getList(WEAK_KEY);
    if(ids.length===0) { alert("No weakness!"); return; }
    pool = allData.filter(d => ids.includes(d.id));
  }
  else if(mode === 'bookmark') {
    const ids = getList(BK_KEY);
    if(ids.length===0) { alert("No bookmarks!"); return; }
    pool = allData.filter(d => ids.includes(d.id));
  }

  if(pool.length === 0) { alert("Data loading..."); return; }
  pool = shuffle(pool);
  
  if(mode.includes('quick')) pool = pool.slice(0, 10);
  if(mode.includes('hard')) pool = pool.slice(0, 30);
  if(mode.includes('saa_quick')) pool = pool.slice(0, 15);
  if(mode.includes('exam')) {
    const limit = mode.includes('sap') ? 75 : 65;
    pool = pool.slice(0, limit);
  }

  appState.questions = pool;
  showScreen('quizScreen');
  renderQuestion();
}

function renderQuestion() {
  if(!appState.questions.length) return;
  const q = appState.questions[appState.currentIndex];
  const t = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
  
  document.getElementById('qCount').innerText = `Q.${appState.currentIndex+1} / ${appState.mode.includes('endless') || appState.mode.includes('vocab') ?'âˆ':appState.questions.length}`;
  document.getElementById('scorePreview').innerText = `${t.score_label}: ${appState.correctCount}`;
  document.getElementById('progressBar').style.width = ((appState.currentIndex+1)/appState.questions.length*100)+'%';
  document.getElementById('qText').innerText = getLocalizedText(q.q);

  const bkBtn = document.getElementById('btnBookmark');
  if(hasInList(BK_KEY, q.id)) bkBtn.classList.add('active'); else bkBtn.classList.remove('active');

  const b = document.getElementById('levelBadge');
  b.className = 'tag-badge';
  if(appState.mode.includes('clf')) { b.innerText='CLF'; b.classList.add('tag-clf'); }
  else if(appState.mode.includes('sap')) { b.innerText='SAP'; b.classList.add('tag-sap'); }
  else if(appState.mode.includes('vocab')) { b.innerText='Vocab'; b.classList.add('tag-vocab'); }
  else { b.innerText='SAA'; b.classList.add('tag-saa'); }

  const area = document.getElementById('optionsArea');
  area.innerHTML = '';
  const aText = getLocalizedText(q.a);
  let opts = [{t:aText, c:true}];
  
  let distractorPool = [];
  if(appState.mode === 'vocab_clf') distractorPool = vocabClfData;
  else if(appState.mode === 'vocab_saa') distractorPool = vocabSaaData;
  else if(appState.mode === 'vocab_sap') distractorPool = vocabSapData;
  else if(appState.mode.includes('clf')) distractorPool = clfData;
  else if(appState.mode.includes('sap')) distractorPool = sapData;
  else distractorPool = saaData;

  if(distractorPool.length === 0) distractorPool = appState.questions;

  let others = shuffle(distractorPool.filter(d => getLocalizedText(d.a) !== aText));
  const set = new Set([aText]);
  for(let o of others) {
    const txt = getLocalizedText(o.a);
    if(!set.has(txt)) { opts.push({t:txt, c:false}); set.add(txt); if(opts.length >= 4) break; }
  }
  while(opts.length < 4) { opts.push({t:`Option ${opts.length+1}`, c:false}); }
  
  shuffle(opts).forEach((o,i) => {
    const btn = document.createElement('div');
    btn.className = 'option-btn';
    btn.innerHTML = `<span style="font-weight:bold;margin-right:8px;">${String.fromCharCode(65+i)}.</span> ${o.t}`;
    btn.onclick = () => check(btn, o, q);
    area.appendChild(btn);
  });

  document.getElementById('feedbackArea').style.display='none';
  document.getElementById('nextBtn').classList.add('hidden');
  document.getElementById('finishBtn').classList.add('hidden');
}

function check(btn, opt, q) {
  if(document.querySelector('.option-btn.correct') || document.querySelector('.option-btn.wrong')) return;
  const t = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
  const fb = document.getElementById('feedbackArea');
  const trueAns = getLocalizedText(q.a);
  
  document.querySelectorAll('.option-btn').forEach(b => {
    if(b.innerText.includes(trueAns)) b.classList.add('correct');
  });

  if(opt.c) {
    appState.correctCount++;
    fb.style.background = "#e8f5e9";
    fb.querySelector('.feedback-title').innerText = t.correct;
    fb.querySelector('.feedback-title').style.color = "#2e7d32";
    if(appState.mode === 'weakness') removeFromList(WEAK_KEY, q.id);
  } else {
    btn.classList.add('wrong');
    appState.wrongList.push(q);
    fb.style.background = "#ffebee";
    fb.querySelector('.feedback-title').innerText = t.wrong;
    fb.querySelector('.feedback-title').style.color = "#c62828";
    addToList(WEAK_KEY, q.id);
  }

  const point = getLocalizedText(q.t || q.f);
  document.getElementById('explanationText').innerHTML = `
    <strong>${t.solution}:</strong><br>${trueAns}<br><br>
    <span style="font-size:13px;color:#555;">${t.point}: ${point}</span>
    <div style="margin-top:20px; min-height:200px; background:#f9f9f9; border:1px dashed #ccc; text-align:center; display:flex; align-items:center; justify-content:center;">
       <span style="color:#aaa; font-size:12px;">Advertisement (ã“ã“ã«AdSense)</span>
    </div>
  `;
  fb.style.display = 'block';
  fb.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  saveSession();

  const isLast = appState.currentIndex >= appState.questions.length - 1;
  const isEndless = appState.mode.includes('endless') || appState.mode.includes('vocab') || appState.mode === 'weakness' || appState.mode === 'bookmark';
  
  if(isEndless) {
    document.getElementById('nextBtn').innerText = t.next_btn;
    document.getElementById('nextBtn').classList.remove('hidden');
  } else {
    if(isLast) {
      document.getElementById('finishBtn').innerText = t.finish_btn;
      document.getElementById('finishBtn').classList.remove('hidden');
    } else {
      document.getElementById('nextBtn').innerText = t.next_btn;
      document.getElementById('nextBtn').classList.remove('hidden');
    }
  }
}

function nextQuestion() {
  appState.currentIndex++;
  const isEndless = appState.mode.includes('endless') || appState.mode.includes('vocab') || appState.mode === 'weakness' || appState.mode === 'bookmark';
  if(isEndless && appState.currentIndex >= appState.questions.length) {
    if(appState.mode === 'weakness') {
      const ids = getList(WEAK_KEY);
      if(ids.length===0) { alert("Congratulations!"); goHome(); return; }
      appState.questions = allData.filter(d=>ids.includes(d.id));
    }
    appState.questions = shuffle(appState.questions);
    appState.currentIndex = 0;
  }
  renderQuestion();
}

function finishQuiz() {
  stopTimer();
  localStorage.removeItem(SESSION_KEY);
  showScreen('resultScreen');
  const t = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
  const score = Math.round((appState.correctCount / (appState.currentIndex+1)) * 100);
  document.getElementById('finalScore').innerText = `${score}%`;
  
  let msg = "Review";
  if(score >= 90) msg = "Perfect!";
  else if(score >= 70) msg = "Good Job!";
  else if(score >= 50) msg = "Passed";
  document.getElementById('resultMsg').innerText = msg;

  const list = document.getElementById('reviewList');
  list.innerHTML = '';
  if(appState.wrongList.length === 0) {
    list.innerHTML = `<div style="padding:20px;text-align:center;color:#2e7d32;">Perfect!</div>`;
  } else {
    appState.wrongList.forEach(q => {
      const d = document.createElement('div');
      d.className = 'review-item';
      const qt = getLocalizedText(q.q);
      const at = getLocalizedText(q.a);
      d.innerHTML = `<span class="review-q">Q. ${qt}</span><span class="review-a">âœ… ${at}</span>`;
      list.appendChild(d);
    });
  }
}

function saveSession() { localStorage.setItem(SESSION_KEY, JSON.stringify(appState)); }
function checkSession() {
  try {
    const d = localStorage.getItem(SESSION_KEY);
    const area = document.getElementById('resumeArea');
    if(d) {
      const s = JSON.parse(d);
      area.innerHTML = `ğŸ”„ Resume (Q.${s.currentIndex+1})`;
      area.classList.remove('hidden');
    } else area.classList.add('hidden');
  } catch(e) { localStorage.clear(); }
}
function resumeGame() {
  const d = localStorage.getItem(SESSION_KEY);
  if(d) { appState = JSON.parse(d); showScreen('quizScreen'); renderQuestion(); }
}
function shuffle(a) { for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
</script>
</body>

</html>
